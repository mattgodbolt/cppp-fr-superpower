<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title></title>

    <link rel="stylesheet" href="reveal.js/dist/reset.css">
    <link rel="stylesheet" href="reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="reveal.js/dist/theme/moon.css">

    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
    <style>
        div.col2 {
            display: flex;
        }

        div.col2 > div {
            flex: 1;
        }
    </style>
</head>
<body>

<div class="reveal">
    <div class="slides">
        <section>
            <!-- INTRO -->
            <section>
                <h2>C++'s Superpower</h2>
                <h4>Matt Godbolt &mdash; <a href="https://twitter.com/mattgodbolt">@mattgodbolt</a></h4>
                <h6><a href="https://cppp.fr">cppp.fr</a> December 2021</h6>
            </section>
            <section>
                Before we talk about super powers?
                What's the worst thing about C++?
            </section>
            <section>
                <h2>What is a superpower?</h2>
                <dl class="fragment">
                    <dt>Superpower</dt>
                    <dd>A state with a dominant position characterized by its extensive ability to exert influence or
                        project power on a global scale.
                    </dd>
                </dl>
                <aside class="notes">
                    A superpower is something which nobody else possesses.
                </aside>
            </section>
            <section>
                <h2>C++'s Superpower</h2>
                <div>TODO: IMAGE OF SUPERMAN LOGO WITH C++ INSTEAD</div>
            </section>
            <section>
                <h2>What could it be?</h2>
                <ul>
                    <li>Multi-paradigm</li>
                    <li>TODO more</li>
                </ul>
            </section>
            <section>
                <h2>What could it be?</h2>
                <ul>
                    <li>Wrong defaults</li>
                    <li>Legacy</li>
                    <li>Undefined behaviour</li>
                    <li>TODO more</li>
                </ul>
            </section>
            <section>
                <h2>Backwards compatibility!</h2>
            </section>
            <section>
                Maybe for the conclusion slides?
                even talk about how Compiler Explorer came about partially as moving forward incrementally wilhe keeping
                backwards compat with a trading system?
            </section>
        </section>

        <section>
            <!-- back story -->
            <section>
                <h2>Backstory</h2>
            </section>
            <section>
                <h2>History</h2>
                <ul>
                    <li>80s to early 90s - 6502 and ARM assembly</li>
                    <li>1994 discovered C</li>
                    <li>1997 started writing C++</li>
                    <li>...</li>
                    <li>2020 rediscovered 1995-era code...</li>
                </ul>
            </section>
            <section>
                <h2>What is a MUD?</h2>
                <ul>
                    <li>Dungeons &amp; Dragons</li>
                    <li>Multiplayer</li>
                    <li>Raw TCP clients</li>
                </ul>
            </section>
            <section>
                <h2>What is a MUD?</h2>
                <div>A giant text processor</div>
                taking user input! classic c code strong suit...er..
            </section>
            <section>
                <h2>The goal</h2>
                <ul>
                    <li>Take 90s-era C</li>
                    <li>Port to modern C++17 (C++20?)</li>
                    <li>Incrementally!</li>
                </ul>
            </section>
        </section>

        <section>
            <!-- The beginning -->
            <section>
                <h2>Groundwork</h2>
                <ul>
                    <li><code>git</code></li>
                    <li><code>cmake</code></li>
                    <li><code>-Wall -Wextra</code></li>
                    <li><code>clang-format</code></li>
                    <li><code>-fsanitize=...</code></li>
                    <li><a href="https://conan.io">conan</a></li>
                </ul>
            </section>
            <section>
                <h2>The most important thing</h2>
                <ul>
                    <li>Manual tests (to begin with)</li>
                    <li>Tests! Catch2</li>
                </ul>
            </section>
            <section>
                <h2>The C++ification</h2>
                <pre><code data-trim>
                $ rename .c .cpp *.c
                $ rename .h .hpp *.h
                </code></pre>
            </section>
            <section>
                <h2>overlap</h2>
                <div>TODO venn diagram of D&amp;D vs C++, and string formatting showing class and template</div>
            </section>
        </section>

        <section>
            <!-- incremental updates -->
            <section data-auto-animate>
                <h2>How to improve?</h2>
                <pre data-auto-animate-id="code"><code data-trim data-noescape class="cpp">
struct area_data {
  AREA_DATA *next;
  char *name;
  sh_int age;
  sh_int nplayer;
  bool empty;
  char *areaname;
  char *filename;
  int lvnum;
  int uvnum;
  int vnum;
};

typedef struct area_data AREA_DATA;
AREA_DATA *areas;</code></pre>
            </section>
            <section data-auto-animate="">
                <h2>How to improve?</h2>
                <div class="col2">
                    <div>
                        <pre data-auto-animate-id="code"><code data-trim data-noescape class="cpp">
struct area_data {
  AREA_DATA *next;  <span class="fragment" data-fragment-index="1">// hand-rolled</span>
  char *name;       <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">, c-style</span>
  sh_int age;
  sh_int nplayer;
  bool empty;
  char *areaname;   <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">, c-style</span>
  char *filename;   <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">, c-style</span>
  int lvnum;
  int uvnum;
  int vnum;
};
<span class="fragment" data-fragment-index="4">// Unnecessary!</span>
typedef struct area_data AREA_DATA;
AREA_DATA *areas;   <span class="fragment" data-fragment-index="5">// Global!</span>
</code></pre>
                    </div>
                    <div>
                        <ul>
                            <li class="fragment" data-fragment-index="1">Hand-rolled linked list</li>
                            <li class="fragment" data-fragment-index="2">Not <code>const</code> correct</li>
                            <li class="fragment" data-fragment-index="3">C-style strings!</li>
                            <li class="fragment" data-fragment-index="4">Unnecessary <code>typedef</code></li>
                            <li class="fragment" data-fragment-index="5">Global!</li>
                            <li class="fragment">Encapsulation, <code>class</code></li>
                        </ul>
                    </div>
                </div>
            </section>
            <section>
                <h2>Simple fix</h2>
                <div class="col2">
                    <div><pre><code data-trim data-noescape class="cpp">
struct area_data {
  AREA_DATA *next;
  // ...
};
typedef struct area_data AREA_DATA;
                    </code></pre>
                    </div>
                    <div><pre><code data-trim data-noescape class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  // ...
};
                    </code></pre>
                    </div>
                </div>
            </section>
            <section>
                <h2>Changing an element</h2>
                <div class="col2">
                    <div><pre><code data-trim data-noescape class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  char *name;         // <---
  char *areaname;
  char *filename;
  // ...
};
                </code></pre>
                    </div>
                    <div><pre><code data-trim data-noescape class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;   // <---
  char *areaname;
  char *filename;
  // ...
};
                </code></pre>
                    </div>
            </section>
            <section>
                <h2>Changing an element</h2>
                <h5>Compile errors...</h5>
                <ul>
                    <li>Assignment</li>
                    <li><code>.c_str()</code></li>
                    <li><code>snprintf</code> warnings...</li>
                    <li><code>__attribute__((format(printf, 2, 3)</code></li>
                    <li>Sanitizer!</li>
                    <li>Testing is just run the app</li>
                </ul>
            </section>
            <section>
                <h2>So now...</h2>
                <div>
                    <pre><code data-trim data-noescape class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};
                    </code></pre>
                </div>
            </section>
            <section>
                <h2>Replace linked-list with STL</h2>
                pointer stability, vector of unique ptr
            </section>
            <section>
                <h2>So now...</h2>
                <div>
                    <pre><code data-trim data-noescape class="cpp">
struct AREA_DATA {
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};

std::vector&lt;std::unique_ptr&lt;AREA_DATA&gt;&gt; areas; // still global
                    </code></pre>
                </div>
            </section>
            <section>
                <h2>Class-i-fy</h2>
                <ul>
                    <li>struct->class but public:</li>
                    <li>move each inside, build test</li>
                    <li>accessor functions</li>
                </ul>
            </section>
            <section>
                <h2>Class-i-fy</h2>
                <ul>
                    <li>Start moving functionality</li>
                    <li>AREA *load_area -> Area::parse</li>
                    <li>Start writing tests!</li>
                </ul>
            </section>
            <section>
                <h2>Class-i-fied</h2>
                <div class="col2">
                    <div><pre><code data-trim data-noescape class="cpp">
class Area {
  std::string description_;
  ush_int num_players_{};
  bool empty_since_last_reset_{};
  int min_level_{0};
  int max_level_{MAX_LEVEL};
  std::string short_name_;

  Area() = default;
  void reset();
                </code></pre>
                    </div>
                    <div><pre><code data-trim data-noescape class="cpp">
public:
  static Area parse(
    FILE *fp,
    std::string filename);

  void player_entered();
  void player_left();
  void update();

  [[nodiscard]]
  const auto &short_name() const {
    return short_name_;
  }
  // etc...
};
                </code></pre>
                    </div>
                </div>
            </section>
            <section>
                <h2>Test</h2>
                <pre><code data-trim data-noescape class="cpp">
TEST_CASE("area loading") {
  test::MemFile fp(R"(ignored~
Short name~
{ 1 50} TheMoog Some kind of area~
6200 6399
)");
  auto area = Area::parse(fp.file(), "bob");
  CHECK(area.filename() == "bob");
  CHECK(area.short_name() == "Short name");
  CHECK(area.description() == "{ 1 50} TheMoog Some kind of area");
  CHECK(area.min_level() == 1);
  CHECK(area.max_level() == 50);
}
                </code></pre>
            </section>
        </section>

        <section>
            <!-- fmt changes -->
            so much of the code is manipulating strings. lots of "template" strings in data,
            lots of printf-style things.
            galaxy brain meme? printf, annotated printf, fmt!
            1. annotate the printf things with gcc things to treat as such
            2. fix bugs
            3. start replacing functions with ones returning string
            4. add equivalent fmt ones
            5. slowly switch over
        </section>

        <section>
            <!-- range goodness -->
            <section>
                <ul>
                    <li>string manipulation functions</li>
                    <li>show evolution of initial_caps_only (also code gen!)
                        - original
                        - mutable range
                        - (not checked in)
                        <pre><code>std::string initial_caps_only(std::string_view text) {
    return text | ranges::view::enumerate | ranges::view::transform([](const auto &pair) {
               return pair.first == 0 ? toupper(pair.second) : tolower(pair.second);
           })
           | ranges::&lt;std::string&gt;
}</code></pre>
                        - final
                        <pre><code>std::string initial_caps_only(std::string_view text) {
    return ranges::view::concat(text | ranges::view::take(1) | ranges::view::transform(toupper),
                                text | ranges::view::drop(1) | ranges::view::transform(tolower))
           | ranges::to&lt;std::string&gt;;
}</code></pre>
                    </li>
                    <li>Show joyous matches_inside implementation</li>
                </ul>
            </section>
        </section>

        <section>
            Strong types
        </section>

        <section>
            Bit fields?
        </section>

        <section>
            Adding pronouns?
        </section>

        <section>
            <h3>Conclusion</h3>
            <aside class="notes">
                <ul>
                    <li>want people to realise that some things in C++ are that way because of back compat</li>
                    <li>while often annoying backpat lets folks do this!</li>
                    <li>not so important for some never-used code like xania, but</li>
                </ul>
            </aside>
        </section>
    </div>
</div>

<script src="reveal.js/dist/reveal.js"></script>
<script src="reveal.js/plugin/notes/notes.js"></script>
<script src="reveal.js/plugin/markdown/markdown.js"></script>
<script src="reveal.js/plugin/highlight/highlight.js"></script>
<script>
    Reveal.initialize({
        width: 1200,
        height: 700,
        hash: true,
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>

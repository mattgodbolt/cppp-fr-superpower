<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title></title>

    <link rel="stylesheet" href="reveal.js/dist/reset.css">
    <link rel="stylesheet" href="reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="reveal.js/dist/theme/moon.css">

    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
    <style>
        div.col2 {
            display: flex;
        }

        div.col2 > div {
            flex: 1;
        }

        pre.terminal {
            background: #000;
        }

        table.galaxy {
            background: white;
            border: none;
            color: black;
            border-collapse: collapse;
            padding: 0;
        }

        table.galaxy tr {
            padding: 0;
            margin: 0;
            border: none;
        }

        table.galaxy td {
            padding: 0;
            margin: 0;
            border: none;
        }

        table.galaxy td.word {
            padding: 10px;
            vertical-align: middle;
        }

        table.galaxy img {
            margin: 0;
            padding: 0;
        }

        span.ansi-white {
            color: #d3d7cf;
        }

        img.allthethings {
            float: right;
            margin: -20px 0 0;
        }

        img.conan {
            float: left;
            margin: 0 20px 0 0;
        }
    </style>
</head>
<body>

<div class="reveal">
    <div class="slides">
        <section>
            <!-- INTRO -->
            <section>
                <h2>C++'s Superpower</h2>
                <h4>Matt Godbolt &mdash; <a href="https://twitter.com/mattgodbolt">@mattgodbolt</a></h4>
                <h6><a href="https://cppp.fr">cppp.fr</a> December 2021</h6>
            </section>
            <section>
                <h2>C++'s Superpower</h2>
                <img src="images/cppman_hana.jpg" class="stretch" alt="C++ superman">
            </section>
            <section>
                <h2>What could it be?</h2>
                <ul>
                    <li>Ubiquity</li>
                    <li>Performance</li>
                    <li>Multi-paradigm</li>
                    <li>Clear object lifetime</li>
                </ul>
            </section>
            <section>
                <h2>Surely not?</h2>
                <ul>
                    <li>Undefined behaviour</li>
                    <li class="fragment highlight-current-green" data-fragment-index="1">Wrong defaults</li>
                    <li class="fragment highlight-current-green" data-fragment-index="1">Legacy support</li>
                    <li>Confusing syntax</li>
                </ul>
            </section>
            <section>
                <h2>Backwards compatibility!</h2>
            </section>
            <section>
                <h2>The goal</h2>
                <ul>
                    <li>Take 25-year-old code</li>
                    <li>Port to modern C++17</li>
                    <li class="fragment">Incrementally!</li>
                    <li class="fragment">Why so important?</li>
                </ul>
            </section>
        </section>

        <section>
            <!-- back story -->
            <section>
                <h2>But Matt,<br>where will you find 25-year-old code?</h2>
            </section>
            <section>
                <h2>1996</h2>
                <img src="images/Matt1994.jpeg" alt="zomg" class="fragment" data-fragment-index="1">
            </section>
            <section>
                <h2>MUDs!</h2>
            </section>
            <section>
                <h2>What is a MUD?</h2>
                <div class="col2">
                    <div>
                        <ul>
                            <li>Multi-User Dungeon</li>
                            <li>Text-based</li>
                            <li>Dungeons &amp; Dragons</li>
                            <li>Multiplayer</li>
                            <li>Raw TCP clients</li>
                        </ul>
                    </div>
                </div>
            </section>
            <section>
                <h2>Xania</h2>
                <div class="col2 stretch">
                    <div><img src="images/Xania.png" alt="old websites, amirite?"></div>
                    <div>
<pre class="terminal" style="font-size: 27%">
<span style="color: #CC0000; "><b>The Temple Square</b></span>

  This is the most southern end of the Temple of Isca. The surface of
the marble flooring has been chipped and worn by the thousands of feet
which have trampled through here since Midgaard was founded. To the
north, a fine set of curved steps opens before you, leading towards
the sacred altar. The centre of activity in this city is immediately
south of you, at Market Square. You hear faint sounds of battle high
above you and wonder why anyone would wish to fight in this fair city.

<span class="ansi-white"><b>[Exits: north east south west up]</b></span>
<span class="ansi-white">     A small white fountain gushes forth here.</span>
<span class="ansi-white">A verminous gutter rat eyes you greedily and gnashes its teeth.</span>
<span style="color: #75507B; "><b>--> kill rat</b></span>
<span class="ansi-white">Your stab does </span><span style="color: #CC0000; "><b>UNSPEAKABLE</b></span><span
        class="ansi-white"> things to a gutter rat&apos;s head!</span>
<span style="color: #CC0000; "><b>A gutter rat is DEAD!!</b></span>
<span class="ansi-white">You receive 0 experience points.</span>
<span class="ansi-white">A gutter rat hits the ground ... DEAD.</span>
<span class="ansi-white">A gutter rat&apos;s severed head plops on the ground.</span>
<span class="ansi-white">Etaine is unimpressed by your sacrifice but grants you a single gold coin.</span>
<span style="color: #4E9A06; ">Faramir gossips &apos;greetings!&apos;</span>
<span style="color: #75507B; "><b>--> w</b></span>
<span style="color: #CC0000; "><b>Entrance to Cleric&apos;s Guild</b></span>

<span class="ansi-white">  The entrance hall is a small modest room, reflecting the true nature of</span>
<span class="ansi-white">the Clerics.  The exit leads east to the temple square.  A small entrance to</span>
<span class="ansi-white">the bar is in the northern wall.</span>

<span class="ansi-white"><b>[Exits: north east]</b></span>
<span class="ansi-white">A vagabond is here, looking for victims.</span>
<span class="ansi-white">A knight templar is guarding the entrance.</span>
<span style="color: #75507B; "><b>--> look vagabond</b></span>
<span class="ansi-white">He looks pretty mean.</span>
<span class="ansi-white">The vagabond is in excellent condition.</span>

<span class="ansi-white">The vagabond is using:</span>
<span class="ansi-white">&lt;worn on body&gt;      a hard leather jerkin</span>
<span class="ansi-white">&lt;worn around wrist&gt; a leather bracer</span>
<span class="ansi-white">&lt;wielded&gt;           a small sword</span>
<hr>
<span style="color: #75507B; ">150 [</span><span style="color: #CC0000; ">|||</span><span
        style="color: #C4A000; ">|||</span><span style="color: #4E9A06; ">||||</span><span style="color: #75507B; ">] 184/184 1609&gt; </span>w
<span style="color: #75507B; ">150 [</span><span style="color: #CC0000; ">|||</span><span
        style="color: #C4A000; ">|||</span><span style="color: #4E9A06; ">||||</span><span style="color: #75507B; ">] 184/184 1609&gt; </span>look vagabond
<span style="color: #75507B; ">150 [</span><span style="color: #CC0000; ">|||</span><span
        style="color: #C4A000; ">|||</span><span style="color: #4E9A06; ">||||</span><span style="color: #75507B; ">] 184/184 1609&gt; </span>

</pre>
                    </div>
                </div>
                <aside class="notes">
                    Xania is one of the main reasons I graduated with a pretty poor Physics degrees.
                </aside>
            </section>
            <section>
                <h2>What is a MUD?</h2>
                <div class="fragment">A giant text processor!</div>
                <aside class="notes">
                    taking user input! classic c code strong suit...er..
                </aside>
            </section>
        </section>

        <section>
            <!-- The beginning -->
            <section>
                <h2>Groundwork</h2>
                <img class="stretch" src="images/old_hds.jpeg" alt="pile of old HDs">
            </section>
            <section>
                <h2>Groundwork</h2>
                <table>
                    <tr>
                        <th>Language</th>
                        <th>Files</th>
                        <th>Comments</th>
                        <th>Lines of Code</th>
                    </tr>
                    <tr>
                        <td>C</td>
                        <td>67</td>
                        <td>4524</td>
                        <td>50977</td>
                    </tr>
                    <tr>
                        <td>C++</td>
                        <td>6</td>
                        <td>54</td>
                        <td>699</td>
                    </tr>
                    <tr>
                        <td>Perl/make</td>
                        <td>8</td>
                        <td>180</td>
                        <td>717</td>
                    </tr>
                </table>
            </section>
            <section>
                <h2>Groundwork</h2>
                <ul>
                    <li><code>git</code></li>
                    <li class="fragment"><code>CMake</code></li>
                    <li class="fragment"><code>clang-format</code></li>
                    <li class="fragment"><code>-Wall -Wextra -fsanitize=</code>
                        <img src="images/all-the-things.png" alt="all the things" height="80px" class="allthethings">
                    </li>
                    <li class="fragment"><a href="https://conan.io">conan</a>
                        <img src="images/conan_frogarian.png" height="50px" alt="conan" class="conan"></li>
                    <li class="fragment">Run &amp; test!</li>
                </ul>
            </section>
            <section>
                <h2>Demo!</h2>
            </section>
        </section>

        <section>
            <section>
                <h2>The C++-i-fication</h2>
                <pre><code data-trim>
                $ rename .c .cpp *.c
                $ rename .h .hpp *.h
                $ ninja
                ...
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Pop quiz!</h2>
                <img data-id="venn" src="images/cpp-vs-dnd-q.svg" alt="C++ and D&D overlap" class="stretch">
            </section>
            <section data-auto-animate>
                <h2>Pop quiz!</h2>
                <img data-id="venn" src="images/cpp-vs-dnd.svg" alt="C++ and D&D overlap" class="stretch">
            </section>
            <section>
                <h2>Pop quiz!</h2>
                <div><pre><code data-trim data-noescape class="cpp">
                #define CLASS_MAGE 0
                #define CLASS_CLERIC 1
                // etc...
                struct char_data {
                  // ...
                  int class;   /* what class this character is */
                  // ...
                };

                // ...
                /* Display the current flags */
                void display_flags (char *template, CHAR_DATA *ch, int current_val);
                </code></pre>
                </div>
            </section>
        </section>

        <section>
            <section>
                <h2>Process</h2>
                <ul>
                    <li>Small change</li>
                    <li>Test</li>
                    <li>Leave TODOs</li>
                </ul>
                <aside class="notes">
                    Remember point out the TODOs are to let you make minimal changes without feeling bad. Slightly
                    better
                    each step of the way. Ideally TDD - write a test first, but we don't have that luxury yet.
                </aside>
            </section>
            <section>
                <h2>Process</h2>
                <ul>
                    <li>CEDD</li>
                    <li>JRIASWHDD</li>
                    <li>TDD</li>
                </ul>
            </section>
        </section>

        <section>
            <!-- incremental updates -->
            <section>
                <h2>How to improve?</h2>
                <div class="col2">
                    <div>
                        <pre><code data-trim data-noescape class="cpp">
struct area_data {  <span class="fragment" data-fragment-index="6">// class? private?</span>
  struct area_data *next;<span class="fragment" data-fragment-index="1"> // !</span>
  char *name;       <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">/c-style</span>
  sh_int age;
  sh_int nplayer;
  bool empty;
  char *areaname;   <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">/c-style</span>
  char *filename;   <span class="fragment" data-fragment-index="2">// const</span><span class="fragment"
                                                                                        data-fragment-index="3">/c-style</span>
  int vnum;
};

<span class="fragment" data-fragment-index="4">// Unnecessary!</span>
typedef struct area_data AREA_DATA;
extern AREA_DATA *areas;   <span class="fragment" data-fragment-index="5">// Global</span>
</code></pre>
                    </div>
                    <div>
                        <ul>
                            <li class="fragment" data-fragment-index="1">Hand-rolled linked list</li>
                            <li class="fragment" data-fragment-index="2">Mutable strings</li>
                            <li class="fragment" data-fragment-index="3">C-style strings!</li>
                            <li class="fragment" data-fragment-index="4">Unnecessary <code>typedef</code></li>
                            <li class="fragment" data-fragment-index="5">Global!</li>
                            <li class="fragment" data-fragment-index="6">Encapsulation, <code>class</code></li>
                        </ul>
                    </div>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Simple fix</h2>
                <div><pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
struct area_data {
  struct area_data *next;
  // ...
};
typedef struct area_data AREA_DATA;
                    </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Simple fix</h2>
                <div><pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  // ...
};
                    </code></pre>
                </div>
            </section>
            <section>
                <h2>Changing an element</h2>
                <ul>
                    <li>Build</li>
                    <li>Run</li>
                    <li>Manual test</li>
                </ul>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <div><pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  char *name;
  char *areaname;
  char *filename;
  // ...
};
                </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <div><pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;   // Look ma, I'm C++ now!
  char *areaname;
  char *filename;
  // ...
};
                </code></pre>
                </div>
            </section>
            <section>
                <h2>CEDD</h2>
                <div class="stretch">
                    <img src="images/cedd.png" class="fragment" alt="CEDD">
                </div>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <pre data-id="code"><code data-line-numbers data-noescape data-trim class="cpp">
                struct AREA_DATA {
                  AREA_DATA *next;
                  std::string name;
                  // ...
                };

                void report_area(AREA_DATA *pArea) {
                  char buf[MAX_STRING_LENGTH];
                  sprintf(buf, "Area: %s\n", pArea->name);
                  // ...
                }
                </code></pre>
                <pre class="fragment"><code data-noescape data-trim>
warning: format '%s' expects argument of type 'char*',
  but argument 3 has type 'const string'
    |     sprintf(buf, "Area: %s\n", pArea->name);
    |                         ~^
    |                          |
    |                          char*
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <pre data-id="code"><code data-line-numbers data-noescape data-trim class="cpp">
                void report_area(AREA_DATA *pArea) {
                  char buf[MAX_STRING_LENGTH];
                  sprintf(buf, "Area: %s\n", pArea->name);
                  // ...
                }
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <pre data-id="code"><code data-line-numbers data-noescape data-trim class="cpp">
                void report_area(AREA_DATA *pArea) {
                  char buf[MAX_STRING_LENGTH];
                  sprintf(buf, "Area: %s\n", pArea->name<em>.c_str()</em>);
                  // ...
                }
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <pre data-id="code2"><code class="cpp" data-trim data-noescape data-line-numbers>
 /* Adds a line of text to the buffer, formatted. */
void buffer_addline_fmt(BUFFER *buffer, const char *text, ...);
            </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <pre data-id="code2"><code class="cpp" data-trim data-noescape data-line-numbers>
 /* Adds a line of text to the buffer, formatted. */
[[gnu::format(printf, 2, 3)]]
void buffer_addline_fmt(BUFFER *buffer, const char *text, ...);
            </code></pre>
            </section>
            <section>
                <h2>Changing an element</h2>
                <h5>JRIASWHDD</h5>
                <h5 class="fragment">Just run it and see what happens driven development</h5>
            </section>
            <section>
                <h2>Changing an element</h2>
                <pre class="terminal">
<span style="color: #CC0000; "><b>==1090996==ERROR: LeakSanitizer: detected memory leaks</b></span>

<span style="color: #3465A4; "><b>Direct leak of 10 byte(s) in 1 object(s) allocated from:</b></span>
 #0 in __interceptor_strdup (./xania/out/debug/bin/xania+0x1c3d017)
 #1 in load_area(_IO_FILE*, char *) ./xania/src/db.cpp:349
 #2 in boot_db() ./xania/src/db.cpp:301
 ...
                </pre>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <div><pre data-id="code"><code class="cpp" data-noescape data-trim data-line-numbers="|11">
                struct AREA_DATA {
                  AREA_DATA *next;
                  std::string name;
                  // ...
                };

                char *fread_string(FILE *fp); /* Read a string into a static buffer */
                char *str_dup(char *str_to_duplicate); /* duplicates string with malloc */

                void parse_area(AREA_DATA *pArea, FILE *fp) {
                  pArea->name = str_dup(fread_string(fp));
                  // ...rest of area parsing
                }
                </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <div><pre data-id="code"><code class="cpp" data-noescape data-trim data-line-numbers="2">
                void parse_area(AREA_DATA *pArea, FILE *fp) {
                  pArea->name = str_dup(fread_string(fp));
                  // ...rest of area parsing
                }
                </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Changing an element</h2>
                <div><pre data-id="code"><code class="cpp" data-noescape data-trim data-line-numbers>
                void parse_area(AREA_DATA *pArea, FILE *fp) {
                  pArea->name = fread_string(fp);
                  // ...rest of area parsing
                }
                </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>And so on</h2>
                <pre data-id="code-so-on"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;
  char *areaname;
  char *filename;
  // ...
};
                    </code></pre>
            </section>
            <section data-auto-animate>
                <h2>And so on</h2>
                <pre data-id="code-so-on"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};
                    </code></pre>
            </section>
            <section data-auto-animate>
                <h2>What's next?</h2>
                <pre data-id="code-whats-next"><code data-trim data-noescape data-line-numbers="2,9" class="cpp">
struct AREA_DATA {
  AREA_DATA *next;
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};

extern AREA_DATA *areas;
                    </code></pre>
            </section>
            <section data-auto-animate>
                <h2>STL-i-fication</h2>
                <pre data-id="code-whats-next"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};

// TODO(#47): find a way to de-global this.
extern std::vector&lt;AREA_DATA&gt; areas;
                </code></pre>
                <aside class="notes">
                    The direct replacement would have been <code>std::forward_list</code>.
                </aside>
            </section>
            <section data-auto-animate>
                <h2>STL-i-fication</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
                void load_area(FILE *fp) {
                  AREA_DATA area{};
                  parse_area(&area, fp);
                  areas.emplace_back(std::move(area));
                }
                </code></pre>
            </section>
            <section>
                <h2>STL-i-fication</h2>
                <div>
<pre class="terminal">
<span style="color: #CC0000; "><b>ERROR: AddressSanitizer: heap-use-after-free on address</b></span>
<span style="color: #3465A4; "><b>READ of size 2 at xxx188a2 thread T0</b></span>
  #0 in reset_room(Room*) ./xania/src/db.cpp:1037
  #1 in reset_area() ./xania/src/db.cpp:985
...
<span style="color: #4E9A06; "><b>xxx188a2 is located 34 bytes inside of 128-byte region [xxx18880,xxx18900)</b></span>
<span style="color: #75507B; "><b>freed by thread T0 here:</b></span>
  #0 in operator delete(void*, unsigned long)
  #1 in __gnu_cxx::new_allocator&lt;Area&gt;::deallocate(Area*, unsigned long)
  #2 in std::allocator_traits&lt;std::allocator&lt;Area&gt; &gt;::deallocate...
...
<span style="color: #75507B; "><b>previously allocated by thread T0 here:</b></span>
  #0 in operator new(unsigned long)
  #1 in __gnu_cxx::new_allocator&lt;Area&gt;::allocate(unsigned long, void const*)
  #2 in std::allocator_traits&lt;std::allocator&lt;Area&gt; &gt;::allocate...
...
SUMMARY: heap-use-after-free ./xania/src/db.cpp:1037 in reset_room(Room*)
</pre>
                </div>
            </section>
            <section>
                <h2>STL-i-fication</h2>
                <pre><code data-trim data-noescape data-line-numbers="|3|3,8" class="cpp">
                struct ROOM_DATA {
                  //...
                  AREA_DATA *area;
                  //...
                };

                void reset_room(ROOM_DATA *room) {
                  if (room->area->nplayer > 0) {
                    return;
                  }
                  // ...
                }
                </code></pre>
                <h5 class="fragment">Need pointer stability</h5>
            </section>
            <section>
                <h2>STL-i-fication</h2>
                <pre><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};

// TODO(#47): find a way to de-global this.
// TODO(#48): try and remove need for pointer stability.
std::vector&lt;std::unique_ptr&lt;AREA_DATA&gt;&gt; areas;
                    </code></pre>
            </section>
            <section>
                <h2>Class-i-fy</h2>
                <ul>
                    <li><code>struct</code> &rarr; <code>class</code></li>
                    <li>Make all members <code>public:</code></li>
                    <li>One at a time:
                        <ul>
                            <li>make private</li>
                            <li>add accessors</li>
                        </ul>
                    </li>
                </ul>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
struct AREA_DATA {
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
class AREA_DATA {
public:
  std::string name;
  std::string areaname;
  std::string filename;
  // ...
};
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
class AREA_DATA {
  std::string name_;

public:
  std::string areaname;
  std::string filename;

  [[nodiscard]] const std::string &name() const { return name_; }
  // ...
};
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
class AREA_DATA {
  std::string name_;

public:
  std::string areaname;
  std::string filename;

  [[nodiscard]] const std::string &name() const { return name_; }

  void parse(FILE *fp);
  // ...
};
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
class AREA_DATA {
  std::string name_;
  std::string area_name_;

public:
  std::string filename;

  [[nodiscard]] const std::string &name() const { return name_; }
  [[nodiscard]] const std::string &areaname() const { return area_name_; }

  void parse(FILE *fp);
  // ...
};
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>Class-i-fy</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
class AREA_DATA {
  std::string name_;
  std::string area_name_;
  std::string filename_;

public:

  [[nodiscard]] const std::string &name() const { return name_; }
  [[nodiscard]] const std::string &areaname() const { return area_name_; }
  [[nodiscard]] const std::string &filename() const { return filename_; }

  void parse(FILE *fp);
  // ...
};
                </code></pre>
            </section>
            <section>
                <h2>Class-i-fy</h2>
                <ul>
                    <li>Move functionality</li>
                    <li><code>parse_area</code> &rarr; <code>Area::parse</code></li>
                    <li>Write tests!</li>
                    <li>Rename fields &amp; accessors</li>
                </ul>
            </section>
            <section>
                <!-- TODO this doesn't work -->
                <h2>Class-i-fied</h2>
                <div class="col2">
                    <div><pre><code data-trim data-noescape data-line-numbers="|2|" class="cpp">
class Area {
  std::string description_;
  ush_int num_players_{};
  bool empty_since_last_reset_{};
  int min_level_{0};
  int max_level_{MAX_LEVEL};
  std::string short_name_;

  Area() = default;
  void reset();

public:
  // ...continued on next panel -->
                </code></pre>
                    </div>
                    <div><pre><code data-trim data-noescape data-line-numbers="1-3" class="cpp">
  static Area parse(
    FILE *fp,
    std::string filename);

  void player_entered();
  void player_left();
  void update();

  [[nodiscard]]
  const auto &short_name() const {
    return short_name_;
  }
  // etc...
};
                </code></pre>
                    </div>
                </div>
            </section>
            <section>
                <h2>Test</h2>
                <pre><code data-trim data-noescape data-line-numbers class="cpp">
TEST_CASE("area loading") {
  test::MemFile fp(R"(ignored~
Short name~
{ 1 50} TheMoog Some kind of area~
6200 6399)");

  SECTION("should parse") {
    auto area = Area::parse(fp.file(), "bob");
    CHECK(area.filename() == "bob");
    CHECK(area.short_name() == "Short name");
    CHECK(area.description() == "{ 1 50} TheMoog Some kind of area");
    CHECK(area.min_level() == 1);
    CHECK(area.max_level() == 50);
  }
}
                </code></pre>
            </section>
        </section>

        <section>
            <section>
                <h2>String manipulation</h2>
            </section>
            <section>
                <h2>String manipulation</h2>
                <pre><code data-trim data-noescape data-line-numbers class="cpp">
char *capitalize(const char *str) {
  static char strcap[MAX_STRING_LENGTH];
  int i;

  for (i = 0; str[i] != '\0'; i++)
    strcap[i] = LOWER(str[i]);
  strcap[i] = '\0';
  strcap[0] = UPPER(strcap[0]);
  return strcap;
}
                </code></pre>
            </section>
            <section>
                <h2>String manipulation</h2>
                <pre><code data-trim data-noescape data-line-numbers class="cpp">
SECTION("capitalize") {
  CHECK(capitalize("") == ""s);
  CHECK(capitalize("a") == "A"s);
  CHECK(capitalize("A") == "A"s);
  CHECK(capitalize("a monkey") == "A monkey"s);
  CHECK(capitalize("A MONKEY") == "A monkey"s);
  CHECK(capitalize("a MonkeY") == "A monkey"s);
}
                </code></pre>
                <h5 class="fragment">ZOMBIES</h5>
                <aside class="notes">
                    <ul>
                        <li>Zero</li>
                        <li>One</li>
                        <li>Many</li>
                        <li>Boundaries</li>
                        <li>Interfaces</li>
                        <li>Exceptional</li>
                        <li>Simple scenarios, simple solutions</li>
                    </ul>
                </aside>
            </section>
            <section data-auto-animate>
                <h2>String manipulation</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers="|6" class="cpp">
std::string capitalize(const char *str) {
  std::string result;
  result.resize(strlen(str));
  for (int i = 0; i < strlen(str); i++)
    result[i] = std::tolower(str[i]);
  result[0] = std::toupper(result[0]);
  return result;
}
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>String manipulation</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers="|7|8|9-11" class="cpp">
std::string capitalize(const char *str) {
  if (!*str)
    return "";

  std::string result;
  std::transform(
    str, str + strlen(str),
    std::back_inserter(result),
    [](char c) -> char {
      return std::tolower(c);
    }
  );
  return result;
}
                </code></pre>
                <!-- https://godbolt.org/z/Eb3MdTae4 -->
            </section>
            <section data-auto-animate>
                <h2>String manipulation</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers class="cpp">
auto capitalize(std::string_view text) {
  return text
    | ranges::view::enumerate
    | ranges::view::transform(
        [](const auto &pair) -> char {
          return pair.first == 0 ? std::toupper(pair.second)
                                 : std::tolower(pair.second);
        }
      )
    | ranges::to&lt;std::string&gt;;
}
                </code></pre>
            </section>
            <section data-auto-animate>
                <h2>String manipulation</h2>
                <pre data-id="code"><code data-trim data-noescape data-line-numbers="|2|3|4|5" class="cpp">
auto capitalize(std::string_view text) {
  return ranges::view::concat(
    text | ranges::view::take(1) | ranges::view::transform(toupper),
    text | ranges::view::drop(1) | ranges::view::transform(tolower)
  ) | ranges::to&lt;std::string&gt;
}
                </code></pre>
                <!-- https://godbolt.org/z/eKMsvoxnb -->
            </section>
            <section>
                <h2>String manipulation</h2>
                <ul>
                    <li>to uppercase/lowercase</li>
                    <li>whitespace trimming</li>
                    <li>case insensitive matches</li>
                    <li>prefixes/suffixes</li>
                    <li>parsing</li>
                </ul>
                <aside class="notes">
                    Talk about boost string algorithms, why didn't pick them...
                </aside>
            </section>
            <section>
                <h2>String manipulation</h2>
                <pre><code data-trim data-noescape class="cpp">
bool matches_inside(const char *astr, const char *bstr) {
    char c0;
    if ((c0 = LOWER(astr[0])) == '\0')
        return true;

    int sstr1 = strlen(astr);
    int sstr2 = strlen(bstr);

    for (int ichar = 0; ichar <= sstr2 - sstr1; ichar++) {
        if (c0 == LOWER(bstr[ichar]) && has_prefix(astr, bstr + ichar))
            return true;
    }
    return false;
}
                </code></pre>
            </section>
            <section>
                <h2>String manipulation</h2>
                <pre><code data-trim data-noescape class="cpp">
bool matches_inside(std::string_view needle, std::string_view haystack) {
  auto needle_low = needle | ranges::views::transform(tolower);
  auto haystack_low = haystack | ranges::views::transform(tolower);
  return !ranges::search(haystack_low, needle_low).empty();
}
                </code></pre>
            </section>
            <section>
                <h2>More stuff</h2>
                <div class="col2">
                    <div>
                        <pre><code data-trim data-noescape class="cpp">
                        int armor[MAX_AC];
                        // ...
                        for (int i = 0; i < MAX_AC; ++i)
                          armor[i] = 0;
                        // ...
                        for (int i = 0; i < MAX_AC; ++i)
                          armor[i] = -1;
                        </code></pre>
                    </div>
                    <div>
                        <pre><code data-trim data-noescape class="cpp">
                        std::array&lt;int, MAX_AC&gt; armour {};
                        // ...
                        ranges::fill(armour, -1);
                        </code></pre>
                    </div>
                </div>
            </section>
        </section>

        <section>
            <section>
                <h2>String formatting</h2>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
char buf[MAX_STRING_LENGTH];
sprintf(buf, "Your gain is: %d/%d hp, %d/%d m, %d/%d mv %d/%d prac.\n",
  add_hp, ch->max_hit, add_mana, ch->max_mana,
  add_move, ch->max_move, add_prac, ch->practice);
send_to_player(ch, buf);
</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
char buf[MAX_STRING_LENGTH];
snprintf(buf, sizeof(buf),
  "Your gain is: %d/%d hp, %d/%d m, %d/%d mv %d/%d prac.\n",
  add_hp, ch->max_hit, add_mana, ch->max_mana,
  add_move, ch->max_move, add_prac, ch->practice);
send_to_player(ch, buf);
</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
void Char::send_to(CHAR *ch, const char *fmt, ...);

ch->send_to(
  "Your gain is: %d/%d hp, %d/%d m, %d/%d mv %d/%d prac.\n",
  add_hp, ch->max_hit, add_mana, ch->max_mana,
  add_move, ch->max_move, add_prac, ch->practice);
</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
[[gnu::format(printf, 2, 3)]]
void Char::send_to(CHAR *ch, const char *fmt, ...);

ch->send_to(
  "Your gain is: %d/%d hp, %d/%d m, %d/%d mv %d/%d prac.\n",
  add_hp, ch->max_hit, add_mana, ch->max_mana,
  add_move, ch->max_move, add_prac, ch->practice);
</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
void Char::send_to(std::string_view txt);
template &lt;typename... Args&gt;
void Char::send_to(std::string_view format, Args &&... args) const {
  return send_to(fmt::format(format, std::forward&lt;Args&gt;(args)...));
}

ch->send_to(
  "Your gain is: {}/{} hp, {}/{} m, {}/{} mv {}/{} prac.",
  add_hp, ch->max_hit, add_mana, ch->max_mana,
  add_move, ch->max_move, add_prac, ch->practice);
</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <pre><code data-noescape data-trim class="cpp">
ch->send_line(
  "You can train: {}.",
  fmt::join(
    ranges::views::concat(
      all_stats | ranges::views::filter([&](auto stat) {
        return ch->perm_stat[stat] < get_max_train(ch, stat);
      }) | ranges::views::transform(to_short_string),
      always_trainable
    ),
    " "sv
  )
);

</code></pre>
            </section>
            <section>
                <h2>String formatting</h2>
                <table class="galaxy">
                    <tr class="fragment">
                        <td class="word"><code>sprintf()</code></td>
                        <td><img src="images/galaxy1.jpeg" alt="galaxy 1"></td>
                    </tr>
                    <tr class="fragment">
                        <td class="word"><code>snprintf()</code></td>
                        <td><img src="images/galaxy2.jpeg" alt="galaxy 2"></td>
                    </tr>
                    <tr class="fragment">
                        <td class="word"><code>[[gnu::format(printf...)]]</code></td>
                        <td><img src="images/galaxy3.jpeg" alt="galaxy 3"></td>
                    </tr>
                    <tr class="fragment">
                        <td class="word"><code>fmt::format()</code></td>
                        <td><img src="images/galaxy4.jpeg" alt="galaxy 4"></td>
                    </tr>
                </table>
            </section>
        </section>

        <section>
            <!-- proto range goodness -->
            <section>
                <h2>Ranges</h2>
            </section>
            <section>
                <h2>Ranges</h2>
                <pre><code data-trim data-noescape data-line-numbers class="cpp">
                void Char::yell(std::string_view exclamation) const {
                  send_line("You yell '{}'", exclamation);

                  ranges::for_each(
                    descriptors().all_but(*this)
                    | DescriptorFilter::same_area(*this)
                    | DescriptorFilter::to_character(),
                    [&](auto &victim)  {
                      victim.send_line("{} yells '{}'", describe_for(victim), exclamation);
                    }
                  );
                }
                </code></pre>
            </section>
        </section>

        <section>
            Strong types, bit fields
        </section>

        <section>
            <!--- TODO probably more in the techniques for adapting old code to new -->
            <section>
                <h2>Parsing</h2>
                <div>
                    <pre><code data-noescape data-trim data-line-numbers class="cpp">
                    typedef void DO_FUN(CHAR_DATA *ch, char *argument);

                    void parse(Char *ch, char *line) {
                      char command[MAX_LINE_LENGTH];
                      char *remainder = one_argument(line, command);
                      DO_FUN *func = find_command(command);

                      if (!func) {
                        send_to_char(ch, "Huh?\n");
                        return;
                      }

                      (*func)(ch, remainder);
                    }
                    </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Parsing</h2>
                <div><pre data-id="code"><code data-noescape data-trim data-line-numbers class="cpp">
// ...
void do_save(Char *ch, char *args);
void do_say(Char *ch, char *args);
void do_score(Char *ch, char *args);
void do_sell(Char *ch, char *arg);
void do_set(Char *ch, char *arg);
// ...
                    </code></pre>
                </div>
            </section>
            <section data-auto-animate>
                <h2>Parsing</h2>
                <div><pre data-id="code"><code data-noescape data-trim data-line-numbers class="cpp">
// ...
void do_save(Char *ch);                 // no args!
void do_say(Char *ch, ArgParser args);  // takes a parser obj
void do_score(Char *ch);                // no args!
void do_sell(Char *ch, ArgParser args); // takes a parser obj
void do_set(Char *ch, char *arg);       // TODO(#55) update this!
// ...
                </code></pre>
                </div>
            </section>
            <section>
                <h2>Parsing</h2>
                <pre><code data-noescape data-trim class="cpp">
                class ArgParser {
                public:
                  explicit ArgParser(std::string args);

                  bool empty() const;
                  std::string_view shift();
                  std::optional&lt;int&gt; try_parse_int();
                  // other parse methods here...

                  // Legacy support...
                  const char *c_str() const;
                };
                </code></pre>
            </section>
            <section>
                <h2>Parsing</h2>
                <div class="col2">
                    <div><pre><code data-noescape data-trim class="cpp">
typedef void (*do_func)(
  Char *ch, char *argument);
void add_command(
  const char *command,
  do_func func);

// ...

add_command("save", do_save);
add_command("say", do_say);
                    </code></pre>
                    </div>
                    <div><pre><code data-noescape data-trim class="cpp">
using Handler =
  std::function&lt;void (Char *,
                      ArgParser args)&gt;;
void add_command(
  const char *name, Handler handler);
void add_command(
  const char *name,
  void (*d)(Char *, const char *)) {
  add_command(
    name,
    [](Char *c, ArgParser args) {
      d(c, args.c_str(); }
    });
}
                </code></pre>
                    </div>
                </div>
            </section>
        </section>

        <section>
            New functionality! Traditional testing, mocking etc
            Still todo - unglobalisation
            Started singleton-ing things, still a ways to go
            One "Mud" class needed?
            Fuzzing!
            C++20
        </section>

        <section>
            Maybe for the conclusion slides?
            even talk about how Compiler Explorer came about partially as moving forward incrementally while keeping
            backwards compat with a trading system?
            Also! we take advantage of this every day when we build systems:
            * We can incrementally move along from C++11, 14, 17, 20
            * AND we know our code is safe for years to come!
            Maybe you'll be presenting 25 year-old code one day?
        </section>

        <section>
            <h3>Conclusion</h3>
            <ul>
                <li>Compiler warnings</li>
                <li>Sanitisers</li>
                <li>TDD-ish</li>
                <li>Epochs?</li>
            </ul>
            <aside class="notes">
                <ul>
                    <li>want people to realise that some things in C++ are that way because of back compat</li>
                    <li>while often annoying backwards compat lets folks do this!</li>
                    <li>not so important for some never-used code like xania, but</li>
                </ul>
            </aside>
        </section>
        <section>
            <h3>Thanks to</h3>
            <ul>
                <li>Rob Snell</li>
                <li>Hana Dusíková</li>
            </ul>
        </section>
    </div>
</div>

<script src="reveal.js/dist/reveal.js"></script>
<script src="reveal.js/plugin/notes/notes.js"></script>
<script src="reveal.js/plugin/markdown/markdown.js"></script>
<script src="reveal.js/plugin/highlight/highlight.js"></script>
<script>
    Reveal.initialize({
        width: 1200,
        height: 700,
        hash: true,
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>
